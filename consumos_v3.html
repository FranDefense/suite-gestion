<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Layer4 Solutions - Gestión de Consumos</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #0b2187;
            --primary-light: #1e3a8a;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-dark: #2d3748;
            --vdf-color: #E60000;
            --mvs-color: #019DF4;
            --accent: #10b981;
            --white: #ffffff;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            color: var(--text);
        }

        /* --- NUEVA NAVEGACIÓN SUPERIOR v1.9 --- */
        nav {
            background: var(--primary);
            color: white;
            height: 65px;
            display: flex;
            align-items: center;
            padding: 0 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .logo { font-weight: 800; font-size: 1.1rem; margin-right: 2.5rem; letter-spacing: 1px; }
        
        .nav-links { display: flex; list-style: none; margin: 0; padding: 0; height: 100%; }
        
        .nav-item { position: relative; height: 100%; display: flex; align-items: center; }
        
        .nav-link {
            padding: 0 1.2rem;
            text-decoration: none;
            color: rgba(255,255,255,0.8);
            font-weight: 600;
            font-size: 0.85rem;
            height: 100%;
            display: flex;
            align-items: center;
            transition: 0.3s;
        }
        
        .nav-item:hover > .nav-link { color: white; background: rgba(255,255,255,0.1); }
        
        /* --- DROPDOWNS --- */
        .dropdown {
            position: absolute;
            top: 65px;
            left: 0;
            background: white;
            min-width: 200px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-radius: 0 0 8px 8px;
            display: none;
            flex-direction: column;
            border: 1px solid #e2e8f0;
        }
        
        .nav-item:hover .dropdown { display: flex; animation: fadeIn 0.2s ease-out; }
        
        .dropdown-item {
            padding: 12px 20px;
            text-decoration: none;
            color: var(--text-dark);
            font-size: 0.8rem;
            font-weight: 500;
            border-bottom: 1px solid #f1f5f9;
            transition: 0.2s;
        }
        
        .dropdown-item:hover { background: #f8fafc; color: var(--primary); padding-left: 25px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* --- STATUS INDICATOR --- */
        .status-container { margin-left: auto; display: flex; align-items: center; }
        #network-status { font-size: 0.7rem; font-weight: 700; padding: 5px 12px; border-radius: 20px; display: flex; align-items: center; gap: 6px; }
        .online { background: #dcfce7; color: #166534; }
        .offline { background: #fee2e2; color: #991b1b; }
        .status-dot { width: 7px; height: 7px; border-radius: 50%; background: currentColor; }

        .tabs-container {
            background: white;
            display: flex;
            justify-content: center;
            border-bottom: 1px solid #edf2f7;
        }

        .tab-item {
            padding: 1rem 2.5rem;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.95rem;
            color: #718096;
            border-bottom: 3px solid transparent;
            transition: 0.3s;
        }

        .tab-item.active-vdf { color: var(--vdf-color); border-bottom-color: var(--vdf-color); }
        .tab-item.active-mvs { color: var(--mvs-color); border-bottom-color: var(--mvs-color); }

        .main-content {
            flex: 1;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .dashboard-container { display: none; }
        .dashboard-container.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card-bg); padding: 2.5rem; border-radius: 16px; box-shadow: 0 4px 25px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        h1 { margin-top: 0; font-size: 1.8rem; border-left: 4px solid var(--primary); padding-left: 1rem; }

        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .upload-box {
            border: 2px dashed #e2e8f0;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            background: #fff;
        }
        .upload-box label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 0.85rem; color: var(--secondary); }

        /* --- Estilos Ajustes Manuales --- */
        .ajustes-box {
            background: #f1f5f9;
            padding: 1.5rem;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid #e2e8f0;
        }
        .ajustes-form {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: flex-end;
            margin-bottom: 15px;
        }
        .ajustes-form input {
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 0.9rem;
            width: 140px;
        }
        .btn-add { background: var(--secondary); color: white; padding: 8px 15px; font-size: 0.8rem; border-radius: 6px; border: none; cursor: pointer; }
        .lista-ajustes {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .badge-ajuste {
            background: white;
            border: 1px solid #cbd5e1;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-del { color: red; cursor: pointer; font-weight: bold; border: none; background: none; }

        .actions { display: flex; gap: 1rem; justify-content: center; margin-bottom: 1rem; }

        button { padding: 1rem 2rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.3s; color: white; }
        .btn-vdf { background: var(--vdf-color); }
        .btn-mvs { background: var(--mvs-color); }
        .btn-success { background: #10b981; display: none; }

        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin: 2rem 0; }
        .kpi-card { background: #f8fafc; padding: 1.5rem; border-radius: 12px; text-align: center; border-top: 4px solid #e2e8f0; }
        .kpi-card h3 { margin: 0; font-size: 0.75rem; color: #718096; text-transform: uppercase; }
        .kpi-card span { font-size: 1.5rem; font-weight: 800; }

        table { width: 100%; border-collapse: collapse; margin-top: 2rem; background: white; }
        th { text-align: left; padding: 1rem; background: #f8fafc; border-bottom: 2px solid #edf2f7; font-size: 0.8rem; color: #718096; text-transform: uppercase; }
        td { padding: 1rem; border-bottom: 1px solid #edf2f7; font-size: 0.9rem; }
        .row-alarm { background-color: #fff5f5; border-left: 5px solid red; }
        .alarm-badge { background: red; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }

        footer { background: #ffffff; padding: 1.5rem; text-align: center; border-top: 1px solid #edf2f7; font-size: 0.85rem; color: #a0aec0; margin-top: 3rem; }
    </style>
</head>
<body>

    <nav>
        <div class="logo">LAYER4 <span style="font-weight: 300;">SOLUTIONS</span></div>
        <ul class="nav-links">
            <li class="nav-item"><a href="index.html" class="nav-link">Inicio</a></li>
            <li class="nav-item">
                <a href="#" class="nav-link">At. Cliente ▾</a>
                <div class="dropdown">
                    <a href="atencion_cliente.html" class="dropdown-item">Gestor y Correo</a>
                </div>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Operaciones ▾</a>
                <div class="dropdown">
                    <a href="consumos_v3.html" class="dropdown-item">Consumos Roaming</a>
                </div>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Facturación ▾</a>
                <div class="dropdown">
                    <a href="vozydatos_exp.html" class="dropdown-item">Vodafone (PDF)</a>
                    <a href="calculadoras.html" class="dropdown-item">Herramientas precios</a>
                </div>
            </li>
            <li class="nav-item"><a href="changelog.html" class="nav-link">Changelog</a></li>
        </ul>
        <div class="status-container">
            <div id="network-status" class="online">
                <div class="status-dot"></div><span id="status-text">Online</span>
            </div>
        </div>
    </nav>
    <div class="tabs-container">
        <div class="tab-item active-vdf" onclick="showTab('vdf')" id="tabVdf">Vodafone (VDF)</div>
        <div class="tab-item" onclick="showTab('mvs')" id="tabMvs">Movistar (MVS)</div>
    </div>

    <div class="main-content">
        
        <div id="vdf-dash" class="dashboard-container active">
            <div class="card">
                <h1>Analizador Vodafone</h1>
                <div class="file-grid">
                    <div class="upload-box"><label>1. Líneas</label><input type="file" id="vdf_lineas"></div>
                    <div class="upload-box"><label>2. Consumos</label><input type="file" id="vdf_consumos"></div>
                    <div class="upload-box"><label>3. ICC (Opcional)</label><input type="file" id="vdf_iccid"></div>
                </div>

                <div class="ajustes-box">
                    <div style="font-weight: 700; font-size: 0.85rem; color: var(--secondary); margin-bottom: 10px;">Ajustes de Descuento Manual (GB)</div>
                    <div class="ajustes-form">
                        <div><label style="font-size:10px; display:block">Línea</label><input type="text" id="vdf_adj_tel" placeholder="600000000"></div>
                        <div><label style="font-size:10px; display:block">Restar Nac.</label><input type="number" id="vdf_adj_n" placeholder="0.0"></div>
                        <div><label style="font-size:10px; display:block">Restar Roa.</label><input type="number" id="vdf_adj_r" placeholder="0.0"></div>
                        <button class="btn-add" onclick="agregarAjuste('VDF')">Añadir Ajuste</button>
                    </div>
                    <div id="vdf_adj_lista" class="lista-ajustes"></div>
                </div>

                <div class="actions">
                    <button class="btn-vdf" onclick="procesarVDF()">Calcular VDF</button>
                    <button id="btnExportVDF" class="btn-success" onclick="descargarExcel('VDF')">Exportar Excel</button>
                </div>

                <div id="status_vdf" style="text-align:center; margin: 10px 0;"></div>
                <div id="kpis_vdf" class="kpi-grid" style="display:none">
                    <div class="kpi-card" style="border-top-color: var(--vdf-color)"><h3>Nacional</h3><span id="kv_n">0</span></div>
                    <div class="kpi-card" style="border-top-color: var(--vdf-color)"><h3>Roaming</h3><span id="kv_r">0</span></div>
                    <div class="kpi-card" style="border-top-color: var(--vdf-color)"><h3>Total</h3><span id="kv_t">0</span></div>
                    <div class="kpi-card" style="border-top-color: red"><h3>Alertas</h3><span id="kv_a">0</span></div>
                </div>
                <div id="tabla_vdf_res"></div>
            </div>
        </div>

        <div id="mvs-dash" class="dashboard-container">
            <div class="card">
                <h1>Analizador Movistar</h1>
                <div class="file-grid">
                    <div class="upload-box"><label>1. Líneas</label><input type="file" id="mvs_lineas"></div>
                    <div class="upload-box"><label>2. Consumos</label><input type="file" id="mvs_consumos"></div>
                    <div class="upload-box"><label>3. ICC (Opcional)</label><input type="file" id="mvs_iccid"></div>
                </div>

                <div class="ajustes-box">
                    <div style="font-weight: 700; font-size: 0.85rem; color: var(--secondary); margin-bottom: 10px;">Ajustes de Descuento Manual (GB)</div>
                    <div class="ajustes-form">
                        <div><label style="font-size:10px; display:block">Línea</label><input type="text" id="mvs_adj_tel" placeholder="600000000"></div>
                        <div><label style="font-size:10px; display:block">Restar Nac.</label><input type="number" id="mvs_adj_n" placeholder="0.0"></div>
                        <div><label style="font-size:10px; display:block">Restar Roa.</label><input type="number" id="mvs_adj_r" placeholder="0.0"></div>
                        <button class="btn-add" onclick="agregarAjuste('MVS')">Añadir Ajuste</button>
                    </div>
                    <div id="mvs_adj_lista" class="lista-ajustes"></div>
                </div>

                <div class="actions">
                    <button class="btn-mvs" onclick="procesarMVS()">Calcular MVS</button>
                    <button id="btnExportMVS" class="btn-success" onclick="descargarExcel('MVS')">Exportar Excel</button>
                </div>

                <div id="status_mvs" style="text-align:center; margin: 10px 0;"></div>
                <div id="kpis_mvs" class="kpi-grid" style="display:none">
                    <div class="kpi-card" style="border-top-color: var(--mvs-color)"><h3>Total GB</h3><span id="km_t">0</span></div>
                    <div class="kpi-card" style="border-top-color: var(--mvs-color)"><h3>Roaming</h3><span id="km_r">0</span></div>
                    <div class="kpi-card" style="border-top-color: var(--mvs-color)"><h3>Importe</h3><span id="km_i">0</span></div>
                    <div class="kpi-card" style="border-top-color: red"><h3>Alertas</h3><span id="km_a">0</span></div>
                </div>
                <div id="tabla_mvs_res"></div>
            </div>
        </div>

    </div>

    <footer><b>Fran Maestre</b> | Layer4 Solutions 2026</footer>

<script>
    // --- LÓGICA DE AJUSTES DINÁMICOS ---
    let AJUSTES_USUARIO = {}; // Objeto que guardará { 'telefono': {n: GB, r: GB} }

    function agregarAjuste(op) {
        const id = op.toLowerCase();
        const tel = cleanKey(document.getElementById(id + '_adj_tel').value);
        const nac = parseFloat(document.getElementById(id + '_adj_n').value) || 0;
        const roa = parseFloat(document.getElementById(id + '_adj_r').value) || 0;

        if(!tel) return alert("Introduce un número de línea");

        AJUSTES_USUARIO[tel] = { n: nac, r: roa };
        
        // Limpiar inputs
        document.getElementById(id + '_adj_tel').value = "";
        document.getElementById(id + '_adj_n').value = "";
        document.getElementById(id + '_adj_r').value = "";

        dibujarListaAjustes(op);
    }

    function eliminarAjuste(op, tel) {
        delete AJUSTES_USUARIO[tel];
        dibujarListaAjustes(op);
    }

    function dibujarListaAjustes(op) {
        const container = document.getElementById(op.toLowerCase() + '_adj_lista');
        container.innerHTML = "";
        for (const [tel, vals] of Object.entries(AJUSTES_USUARIO)) {
            container.innerHTML += `
                <div class="badge-ajuste">
                    <b>${tel}</b> (N: -${vals.n} / R: -${vals.r}) 
                    <button class="btn-del" onclick="eliminarAjuste('${op}', '${tel}')">×</button>
                </div>`;
        }
    }

    function aplicarRestas(tel, n, r) {
        let finalN = n, finalR = r;
        const key = cleanKey(tel);
        if(AJUSTES_USUARIO[key]) {
            finalN = Math.max(0, n - (AJUSTES_USUARIO[key].n || 0));
            finalR = Math.max(0, r - (AJUSTES_USUARIO[key].r || 0));
        }
        return { n: finalN, r: finalR };
    }

    // --- NAVEGACIÓN ---
    function showTab(tab) {
        document.querySelectorAll('.dashboard-container').forEach(d => d.classList.remove('active'));
        document.getElementById('tabVdf').className = 'tab-item';
        document.getElementById('tabMvs').className = 'tab-item';
        if(tab === 'vdf') {
            document.getElementById('vdf-dash').classList.add('active');
            document.getElementById('tabVdf').classList.add('active-vdf');
        } else {
            document.getElementById('mvs-dash').classList.add('active');
            document.getElementById('tabMvs').classList.add('active-mvs');
        }
    }

    // --- UTILS ---
    function cleanKey(v) {
        if (!v) return "";
        let s = String(v).split('.')[0];
        return s.replace(/\D/g, "");
    }

    function removeAccents(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    async function leerMapaICC(file) {
        if(!file) return null;
        const wb = await leerExcel(file);
        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        const mapa = {};
        data.forEach(r => {
            const keys = Object.keys(r);
            const colTel = keys.find(k => {
                const norm = removeAccents(k.toLowerCase());
                return norm.includes("tel") || norm.includes("linea");
            });
            const colIcc = keys.find(k => k.toLowerCase().includes("icc"));
            if (colTel && colIcc) {
                const tel = cleanKey(r[colTel]);
                const icc = String(r[colIcc] || "").trim();
                if (tel && icc) mapa[tel] = icc;
            }
        });
        return mapa;
    }

    function leerExcel(f) { return new Promise(res => { const r = new FileReader(); r.onload = e => res(XLSX.read(new Uint8Array(e.target.result), {type:'array'})); r.readAsArrayBuffer(f); }); }

    // --- PROCESOS ---
    let resVDF = [], resMVS = [];

    async function procesarVDF() {
        const fl = document.getElementById('vdf_lineas').files[0];
        const fc = document.getElementById('vdf_consumos').files[0];
        const fi = document.getElementById('vdf_iccid').files[0];
        if(!fl || !fc) return alert("Sube líneas y consumos.");

        document.getElementById('status_vdf').innerText = "Procesando...";
        const mapaIcc = await leerMapaICC(fi);
        const wbL = await leerExcel(fl);
        const inv = XLSX.utils.sheet_to_json(wbL.Sheets[wbL.SheetNames[0]]);
        const listaInv = inv.map(r => cleanKey(r[Object.keys(r)[0]])).filter(x => x);

        const wbC = await leerExcel(fc);
        const consRaw = XLSX.utils.sheet_to_json(wbC.Sheets[wbC.SheetNames[0]], wbC.SheetNames[0]==="DATOS"?{range:3}:{});
        
        const acc = {};
        consRaw.forEach(r => {
            const keys = Object.keys(r);
            const tel = cleanKey(r[keys.find(k => k.toLowerCase().includes("tele"))]);
            const tipo = r[keys.find(k => k.toLowerCase().includes("roaming"))];
            const vol = parseFloat(r[keys.find(k => k.toLowerCase().includes("vol"))]) || 0;
            if(!acc[tel]) acc[tel] = {n:0, r:0};
            const gb = (vol/1024/1024)*1.10;
            if(tipo === "N") acc[tel].n += gb; else acc[tel].r += gb;
        });

        resVDF = listaInv.map(t => {
            const c = acc[t] || {n:0, r:0};
            const aj = aplicarRestas(t, c.n, c.r);
            return { Linea: t, ICCID: mapaIcc?.[t] || "---", Nacional: aj.n, Roaming: aj.r, Total: aj.n+aj.r, Alerta: aj.r > 80 };
        });

        dibujarTabla('VDF', !!mapaIcc);
    }

    async function procesarMVS() {
        const fl = document.getElementById('mvs_lineas').files[0];
        const fc = document.getElementById('mvs_consumos').files[0];
        const fi = document.getElementById('mvs_iccid').files[0];
        if(!fl || !fc) return alert("Sube líneas y consumos.");

        document.getElementById('status_mvs').innerText = "Procesando...";
        const mapaIcc = await leerMapaICC(fi);
        const wbL = await leerExcel(fl);
        const invRaw = XLSX.utils.sheet_to_json(wbL.Sheets[wbL.SheetNames[0]]);
        const listaInv = invRaw.map(r => {
            const v = Object.values(r).find(x => cleanKey(x).length >= 9);
            return cleanKey(v);
        }).filter(x => x);

        const wbC = await leerExcel(fc);
        const sh = wbC.Sheets[wbC.SheetNames.find(n => n.toUpperCase().includes("TRÁFICO"))];
        const data = XLSX.utils.sheet_to_json(sh, {header: 1});

        let hRow = -1, cL=-1, cT=-1, cV=-1, cI=-1;
        for(let i=0; i<30; i++) {
            const row = (data[i]||[]).join("|").toUpperCase();
            if(row.includes("TIPO TRÁFICO")) {
                hRow = i;
                data[i].forEach((v, idx) => {
                    const s = removeAccents(String(v).toUpperCase());
                    if(s.includes("LINEA")) cL=idx;
                    if(s.includes("TIPO")) cT=idx;
                    if(s.includes("CANTIDAD")) cV=idx;
                    if(s.includes("IMPORTE")) cI=idx;
                });
                break;
            }
        }

        const acc = {};
        for(let i=hRow+1; i<data.length; i++) {
            const row = data[i];
            const tel = cleanKey(row[cL]);
            if(!tel) continue;
            if(!acc[tel]) acc[tel] = {n:0, r:0, i:0};
            const tipo = String(row[cT]||"");
            acc[tel].i += parseMvsImp(row[cI]);
            const volGB = parseMvsVol(row[cV]);
            if(tipo.includes("EN UE")) acc[tel].r += volGB;
            else if(tipo.includes("CORP PREMIUM")) acc[tel].n += volGB;
        }

        resMVS = listaInv.map(t => {
            const c = acc[t] || {n:0, r:0, i:0};
            const aj = aplicarRestas(t, c.n, c.r);
            return { Linea: t, ICCID: mapaIcc?.[t] || "---", Nacional: aj.n, Roaming: aj.r, Total: aj.n+aj.r, Importe: c.i, Alerta: aj.r > 100 };
        });

        dibujarTabla('MVS', !!mapaIcc);
    }

    function dibujarTabla(op, conIcc) {
        const esVdf = (op === 'VDF');
        const data = esVdf ? resVDF : resMVS;
        const container = document.getElementById(esVdf ? 'tabla_vdf_res' : 'tabla_mvs_res');
        const kpiGrid = document.getElementById(esVdf ? 'kpis_vdf' : 'kpis_mvs');
        
        let tN=0, tR=0, tI=0, al=0;
        let html = `<table><thead><tr><th>Línea</th>${conIcc?'<th>ICCID</th>':''}<th>Nacional</th><th>Roaming</th><th>Total</th>${!esVdf?'<th>Importe</th>':''}</tr></thead><tbody>`;

        data.forEach(r => {
            tN+=r.Nacional; tR+=r.Roaming; if(!esVdf) tI+=r.Importe; if(r.Alerta) al++;
            html += `<tr class="${r.Alerta?'row-alarm':''}">
                <td><b>${r.Linea}</b> ${r.Alerta?'<span class="alarm-badge">ALERTA</span>':''}</td>
                ${conIcc?`<td>${r.ICCID}</td>`:''}
                <td>${r.Nacional.toFixed(3)}</td>
                <td><strong>${r.Roaming.toFixed(3)}</strong></td>
                <td>${r.Total.toFixed(3)}</td>
                ${!esVdf?`<td>${r.Importe.toFixed(2)}€</td>`:''}
            </tr>`;
        });

        container.innerHTML = html + "</tbody></table>";
        kpiGrid.style.display = "grid";
        document.getElementById(esVdf?'kv_n':'km_t').innerText = (esVdf?tN:(tN+tR)).toFixed(2) + " GB";
        document.getElementById(esVdf?'kv_r':'km_r').innerText = tR.toFixed(2) + " GB";
        document.getElementById(esVdf?'kv_t':'km_i').innerText = esVdf ? (tN+tR).toFixed(2)+" GB" : tI.toFixed(2)+" €";
        document.getElementById(esVdf?'kv_a':'km_a').innerText = al;
        document.getElementById(esVdf?'btnExportVDF':'btnExportMVS').style.display = "inline-block";
        document.getElementById(esVdf?'status_vdf':'status_mvs').innerText = "✔ Procesado";
    }

    function parseMvsVol(s) {
        if(!s) return 0;
        let str = String(s).toUpperCase().trim();
        let v = parseFloat(str.replace(",", "."));
        if(str.includes("GB")) return v;
        if(str.includes("MB")) return v/1024;
        if(str.includes("KB")) return v/(1024*1024);
        if(str.endsWith("B")) return v/(1024*1024*1024);
        return v;
    }
    function parseMvsImp(s) { return parseFloat(String(s||"0").replace("€","").replace(",",".")) || 0; }
    function descargarExcel(op) {
        const data = (op === 'VDF') ? resVDF : resMVS;
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Consumos");
        XLSX.writeFile(wb, `Reporte_${op}_Layer4.xlsx`);
    }

        // --- LOGICA RED ---
    function updateOnlineStatus() {
        const s = document.getElementById('network-status');
        const t = document.getElementById('status-text');
        if (navigator.onLine) { s.className = 'online'; t.innerText = 'Online'; }
        else { s.className = 'offline'; t.innerText = 'Modo Offline'; }
    }
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();
    
    // --- LOGICA PWA ---
    let newWorker;
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').then(reg => {
            if (reg.waiting) { newWorker = reg.waiting; showUpdateToast(); }
            reg.addEventListener('updatefound', () => {
                newWorker = reg.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        showUpdateToast();
                    }
                });
            });
        });
        let refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (refreshing) return;
            window.location.reload();
            refreshing = true;
        });
    }
    function showUpdateToast() { 
        const toast = document.getElementById('update-toast');
        if(toast) toast.style.display = 'flex'; 
    }
    function actualizarApp() { if (newWorker) newWorker.postMessage({ action: 'skipWaiting' }); }
    </script>
</body>

</html>

