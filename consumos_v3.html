<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Layer4 Solutions - Gesti√≥n de Consumos v1.8</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #0b2187;
            --primary-dark: #051456;
            --bg: #f8fafc;
            --sidebar-width: 260px;
            --text-dark: #2d3748;
            --accent: #10b981;
            --vdf-color: #E60000;
            --mvs-color: #019DF4;
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; background: var(--bg); height: 100vh; overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar { width: var(--sidebar-width); background: var(--primary); color: white; display: flex; flex-direction: column; transition: margin-left 0.4s cubic-bezier(0.4, 0, 0.2, 1); position: relative; z-index: 1000; flex-shrink: 0; }
        .sidebar.collapsed { margin-left: calc(var(--sidebar-width) * -1); }
        .sidebar-handle { position: absolute; right: -25px; top: 50%; transform: translateY(-50%); width: 25px; height: 70px; background: var(--primary); display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 0 8px 8px 0; box-shadow: 4px 0 10px rgba(0,0,0,0.1); z-index: 1001; }
        .sidebar-handle span { font-size: 14px; transition: transform 0.4s; }
        .sidebar.collapsed .sidebar-handle span { transform: rotate(180deg); }
        .sidebar-header { padding: 2rem 1.5rem; font-weight: 800; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-menu { flex: 1; padding: 1rem 0; overflow-y: auto; }
        .menu-category { padding: 1.5rem 1.5rem 0.5rem; font-size: 0.7rem; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 1px; }
        .menu-item { padding: 0.8rem 1.5rem; display: flex; align-items: center; gap: 12px; text-decoration: none; color: rgba(255,255,255,0.8); transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: white; }
        .sidebar-footer { padding: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.75rem; margin-top: auto; }
        .btn-clean { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; opacity: 0.6; cursor: pointer; width: 100%; border-radius: 4px; padding: 5px; margin-top: 10px; }

        /* --- MAIN CONTENT --- */
        .main-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; min-width: 0; }
        header { background: white; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .container { padding: 2rem; max-width: 1200px; margin: 0 auto; width: 100%; box-sizing: border-box; }

        /* --- TABS --- */
        .tabs-container { background: white; display: flex; border-bottom: 1px solid #edf2f7; margin-bottom: 2rem; border-radius: 12px; overflow: hidden; }
        .tab-item { flex: 1; text-align: center; padding: 1rem; cursor: pointer; font-weight: 700; color: #718096; transition: 0.3s; }
        .tab-item.active-vdf { color: white; background: var(--vdf-color); }
        .tab-item.active-mvs { color: white; background: var(--mvs-color); }

        /* --- CARDS & TABLES (v3 logic) --- */
        .card { background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        .file-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin: 1.5rem 0; }
        .upload-box { border: 2px dashed #e2e8f0; padding: 1rem; border-radius: 10px; text-align: center; }
        .ajustes-box { background: #f1f5f9; padding: 1.2rem; border-radius: 10px; margin: 15px 0; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1.5rem; }
        .kpi-card { background: #fff; padding: 1rem; border-radius: 10px; text-align: center; border-top: 4px solid #cbd5e1; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
        th { text-align: left; padding: 10px; background: #f8fafc; font-size: 0.75rem; color: #718096; }
        td { padding: 10px; border-bottom: 1px solid #edf2f7; font-size: 0.85rem; }
        .row-alarm { background: #fff5f5; border-left: 4px solid red; }

        /* --- NETWORK STATUS --- */
        #network-status { font-size: 0.75rem; font-weight: 700; padding: 4px 12px; border-radius: 20px; display: flex; align-items: center; gap: 6px; }
        .online { background: #dcfce7; color: #166534; }
        .offline { background: #fee2e2; color: #991b1b; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }

        #update-toast { position: fixed; bottom: 20px; right: 20px; background: #2d3748; color: white; padding: 1rem; border-radius: 12px; display: none; align-items: center; gap: 15px; z-index: 10000; }
        .dashboard-container { display: none; }
        .dashboard-container.active { display: block; }
    </style>
</head>
<body>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-handle" onclick="toggleMenu()"><span>‚ùÆ</span></div>
        <div class="sidebar-header">LAYER4 <span style="font-weight: 300;">SOLUTIONS</span></div>
        <nav class="sidebar-menu">
            <div class="menu-category">At. Cliente</div>
            <a href="consumos_v3.html" class="menu-item active"><span>üì∂</span> Consumos Roaming</a>
            <div class="menu-category">Operaciones</div>
            <a href="vozydatos_exp.html" class="menu-item"><span>üìä</span> C√°lculo VDF</a>
            <div class="menu-category">Facturaci√≥n</div>
            <a href="calculadoras.html" class="menu-item"><span>üí∂</span> Calculadoras</a>
            <div class="menu-category">Soporte</div>
            <a href="changelog.html" class="menu-item"><span>üìù</span> Changelog</a>
        </nav>
        <div class="sidebar-footer">
            <div style="opacity: 0.5">Versi√≥n: v1.8</div>
            <button class="btn-clean" onclick="limpiarCacheManual()">‚öôÔ∏è Limpiar Cach√©</button>
        </div>
    </aside>

    <main class="main-wrapper">
        <header>
            <div style="font-weight: 700; color: var(--primary);">GESTI√ìN DE CONSUMOS</div>
            <div id="network-status" class="online"><div class="status-dot"></div><span id="status-text">Online</span></div>
        </header>

        <div class="container">
            <div class="tabs-container">
                <div class="tab-item active-vdf" onclick="showTab('vdf')" id="tabVdf">Vodafone (VDF)</div>
                <div class="tab-item" onclick="showTab('mvs')" id="tabMvs">Movistar (MVS)</div>
            </div>

            <div id="vdf-dash" class="dashboard-container active">
                <div class="card">
                    <h2>Analizador Vodafone</h2>
                    <div class="file-grid">
                        <div class="upload-box"><label>L√≠neas</label><input type="file" id="vdf_lineas"></div>
                        <div class="upload-box"><label>Consumos</label><input type="file" id="vdf_consumos"></div>
                    </div>
                    <div class="actions" style="display:flex; gap:10px; margin-top:20px;">
                        <button style="background:var(--vdf-color); flex:1" onclick="procesarVDF()">Calcular VDF</button>
                    </div>
                    <div id="kpis_vdf" class="kpi-grid" style="display:none">
                        <div class="kpi-card" style="border-top-color: var(--vdf-color)"><h3>Nacional</h3><span id="kv_n">0</span></div>
                        <div class="kpi-card" style="border-top-color: red"><h3>Alertas</h3><span id="kv_a">0</span></div>
                    </div>
                    <div id="tabla_vdf_res"></div>
                </div>
            </div>

            <div id="mvs-dash" class="dashboard-container">
                <div class="card">
                    <h2>Analizador Movistar</h2>
                    <div class="file-grid">
                        <div class="upload-box"><label>L√≠neas</label><input type="file" id="mvs_lineas"></div>
                        <div class="upload-box"><label>Consumos</label><input type="file" id="mvs_consumos"></div>
                    </div>
                    <div class="actions" style="display:flex; gap:10px; margin-top:20px;">
                        <button style="background:var(--mvs-color); flex:1" onclick="procesarMVS()">Calcular MVS</button>
                    </div>
                    <div id="tabla_mvs_res"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="update-toast">
        <span>üöÄ Nueva versi√≥n disponible (v1.8)</span>
        <button onclick="actualizarApp()" style="background:var(--accent); border:none; color:white; padding:8px; border-radius:5px; cursor:pointer;">Actualizar</button>
    </div>

    <script>
        // Mantiene toda tu l√≥gica original de procesamiento de Excel de consumos_v3.html aqu√≠ abajo...
        // [Incluir funciones: agregarAjuste, procesarVDF, procesarMVS, dibujarTabla, etc.]
        
        function toggleMenu() { document.getElementById('sidebar').classList.toggle('collapsed'); }

        function updateOnlineStatus() {
            const status = document.getElementById('network-status');
            const text = document.getElementById('status-text');
            if (navigator.onLine) { status.className = 'online'; text.innerText = 'Online'; }
            else { status.className = 'offline'; text.innerText = 'Modo Offline'; }
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

        // L√≥gica PWA v1.8
        let newWorker;
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(reg => {
                reg.addEventListener('updatefound', () => {
                    newWorker = reg.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            document.getElementById('update-toast').style.display = 'flex';
                        }
                    });
                });
            });
            let refreshing;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                window.location.reload();
                refreshing = true;
            });
        }
        function actualizarApp() { if (newWorker) newWorker.postMessage({ action: 'skipWaiting' }); }
        async function limpiarCacheManual() {
            if (confirm("¬øLimpiar cach√©?")) {
                const names = await caches.keys();
                for (let n of names) await caches.delete(n);
                const regs = await navigator.serviceWorker.getRegistrations();
                for (let r of regs) await r.unregister();
                window.location.reload(true);
            }
        }
        function showTab(tab) {
            document.querySelectorAll('.dashboard-container').forEach(d => d.classList.remove('active'));
            document.getElementById('tabVdf').className = 'tab-item';
            document.getElementById('tabMvs').className = 'tab-item';
            if(tab === 'vdf') {
                document.getElementById('vdf-dash').classList.add('active');
                document.getElementById('tabVdf').classList.add('active-vdf');
            } else {
                document.getElementById('mvs-dash').classList.add('active');
                document.getElementById('tabMvs').classList.add('active-mvs');
            }
        }
    </script>
</body>
</html>
